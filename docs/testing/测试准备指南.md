# ILAL API 测试准备指南

## 当前状态

❌ PostgreSQL 未安装  
❌ 环境变量未配置  
❌ pnpm 未找到  

## 快速配置（3 步完成）

### 步骤 1: 安装必要工具

```bash
# 安装 Homebrew（如果还没有）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装 PostgreSQL
brew install postgresql@14

# 启动 PostgreSQL
brew services start postgresql@14

# 创建数据库
createdb ilal_saas

# 安装 pnpm
brew install pnpm

# 或使用 npm
npm install -g pnpm
```

### 步骤 2: 配置环境变量

```bash
cd /Users/ronny/Desktop/ilal/apps/api

# 复制环境变量模板
cp .env.example .env

# 生成安全密钥并写入 .env
echo "DATABASE_URL=\"postgresql://$(whoami)@localhost:5432/ilal_saas\"" > .env
echo "JWT_SECRET=\"$(openssl rand -hex 64)\"" >> .env
echo "API_KEY_SECRET=\"$(openssl rand -hex 64)\"" >> .env
echo "PORT=3001" >> .env
echo "NODE_ENV=\"development\"" >> .env
echo "RPC_URL=\"https://base-sepolia-rpc.publicnode.com\"" >> .env
echo "CHAIN_ID=84532" >> .env

# 添加区块链配置（需要你提供）
echo "VERIFIER_PRIVATE_KEY=\"0x...\"" >> .env
echo "SESSION_MANAGER_ADDRESS=\"0x53fA67Dbe5803432Ba8697Ac94C80B601Eb850e2\"" >> .env
echo "VERIFIER_ADDRESS=\"0x0cDcD82E5efba9De4aCc255402968397F323AFBB\"" >> .env
```

**重要**: 你需要编辑 `.env` 文件，填入你的 `VERIFIER_PRIVATE_KEY`。

### 步骤 3: 安装依赖和运行测试

```bash
cd /Users/ronny/Desktop/ilal/apps/api

# 安装依赖
pnpm install

# 运行数据库迁移
pnpm db:migrate

# 运行测试
./test-e2e.sh
```

---

## 一键配置脚本（推荐）

```bash
cd /Users/ronny/Desktop/ilal
chmod +x setup-for-test.sh
./setup-for-test.sh
```

---

## 如果你已经有 PostgreSQL

```bash
# 1. 创建数据库
psql -c "CREATE DATABASE ilal_saas;"

# 2. 配置环境变量
cd /Users/ronny/Desktop/ilal/apps/api
cp .env.example .env
# 编辑 .env，设置正确的 DATABASE_URL

# 3. 运行
pnpm install
pnpm db:migrate
./test-e2e.sh
```

---

## 常见问题

### Q: PostgreSQL 安装失败
**解决**: 
```bash
curl https://postgresapp.com/download | sh
# 或从官网下载: https://www.postgresql.org/download/macosx/
```

### Q: pnpm 命令找不到
**解决**:
```bash
npm install -g pnpm
# 或使用 curl
curl -fsSL https://get.pnpm.io/install.sh | sh -
```

### Q: 数据库连接失败
**解决**:
```bash
brew services list | grep postgresql
brew services restart postgresql@14
lsof -i :5432
```

### Q: 没有 VERIFIER_PRIVATE_KEY
**解决**: 如果你只是想测试 API 的认证和计费功能（不包括区块链交互），可以使用测试私钥：

```bash
echo "VERIFIER_PRIVATE_KEY=\"0x$(openssl rand -hex 32)\"" >> .env
```

⚠️ **注意**: 这个私钥在测试网上没有余额，区块链相关的测试会失败，但其他测试（认证、API Key、计费）可以正常运行。
