# ILAL 项目完整报告 v2

> Institutional Liquidity Access Layer — 基于 Uniswap v4 的机构级合规流动性接入层
>
> 报告日期：2026-02-11 | 网络：Base Sepolia (Chain ID: 84532)

---

## 目录

1. [执行摘要](#1-执行摘要)
2. [项目概述](#2-项目概述)
3. [技术架构](#3-技术架构)
4. [智能合约体系](#4-智能合约体系)
5. [零知识证明系统](#5-零知识证明系统)
6. [前端合规流程](#6-前端合规流程)
7. [Multi-Issuer 合规架构（v2 新增）](#7-multi-issuer-合规架构v2-新增)
8. [合规运营工具（v2 新增）](#8-合规运营工具v2-新增)
9. [做市机器人与监控](#9-做市机器人与监控)
10. [部署信息](#10-部署信息)
11. [测试结果](#11-测试结果)
12. [安全分析](#12-安全分析)
13. [问题解决记录](#13-问题解决记录)
14. [Ondo 对接就绪度评估](#14-ondo-对接就绪度评估)
15. [路线图](#15-路线图)

---

## 1. 执行摘要

ILAL 是构建在 **Uniswap v4** 之上的机构级合规流动性接入层，解决的核心问题是：

> **合规机构如何在保护隐私的前提下，接入 DeFi 流动性？**

### 核心价值

| 维度 | 方案 |
|------|------|
| **隐私** | 零知识证明 — KYC 原始数据永远不上链 |
| **合规** | 链上 Session + Hook 拦截 — 每笔交易可审计 |
| **流动性** | Uniswap v4 — DeFi 最深流动性池 |
| **灵活性** | Multi-Issuer — 支持 Coinbase EAS、Ondo KYB、任何自定义 KYC Provider |

### v2 版本关键升级

| 升级项 | 之前 | 现在 |
|--------|------|------|
| Session 激活 | localStorage 本地存储 | **链上 `writeContract → SessionManager.startSession`** |
| 合规策略 | mock fallback（始终放行） | **fail-closed（生产模式无凭证 → 拒绝）** |
| 凭证来源 | 仅 Coinbase EAS | **Multi-Issuer（EAS + 自定义 KYC Provider）** |
| Attestation 校验 | 仅检查 uid | **完整校验（revocation/expiration/attester/schema）** |
| 运营工具 | 无 | **CLI 工具（查询/撤销/批量/导出报告）** |
| Ondo 对接 | 未准备 | **完整集成指南 + 代码接入点** |

### 链上数据（实时）

- **SessionStarted 事件**: 3 笔
- **活跃 Session**: 3 个机构地址
- **SessionEnded**: 0（无异常撤销）
- **合约版本**: 1.0.0

---

## 2. 项目概述

### 2.1 问题定义

传统金融机构（如 Ondo Finance、BlackRock、Franklin Templeton）正在将 RWA（Real World Assets）代币化，但面临困境：

1. **合规要求**：所有参与者必须通过 KYC/KYB
2. **隐私需求**：不能将身份信息暴露在公链上
3. **流动性需求**：代币化资产需要二级市场流动性
4. **审计需求**：监管机构需要完整的交易审计轨迹

### 2.2 ILAL 解决方案

```
┌──────────────────────────────────────────────────────────────┐
│                         ILAL 系统                            │
│                                                              │
│  ┌─────────┐    ┌──────────┐    ┌──────────────┐            │
│  │ ZK Proof │───▶│ Verifier │───▶│SessionManager│            │
│  │ (浏览器) │    │ (链上)    │    │  (链上 24h)  │            │
│  └─────────┘    └──────────┘    └──────┬───────┘            │
│                                        │                     │
│                                 ┌──────▼───────┐            │
│                                 │ComplianceHook│            │
│                                 │ (Uni v4 Hook)│            │
│                                 └──────┬───────┘            │
│                                        │                     │
│                     ┌──────────────────▼──────────────────┐  │
│                     │         Uniswap v4 Pool             │  │
│                     │     USDC/WETH | fee=3000            │  │
│                     └─────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

### 2.3 用户旅程

```
机构用户连接钱包
    │
    ▼
查询合规凭证（Coinbase EAS / Ondo KYB / 自定义 Provider）
    │                           ▲
    │  fail-closed: 无凭证 → 拒绝  │
    ▼                           │
浏览器生成 ZK Proof（~4 秒）
    │
    ▼
链上验证 Proof（PlonkVerifierAdapter.verifyComplianceProof）
    │
    ▼
链上激活 Session（SessionManager.startSession → 24h）
    │
    ▼
Swap / 添加流动性 / 移除流动性
    │
    ▼
ComplianceHook 拦截：检查 Session + EIP-712 签名
    │
    ▼
交易执行 ✓（产生可审计的链上事件）
```

---

## 3. 技术架构

### 3.1 技术栈

| 层级 | 技术 |
|------|------|
| 智能合约 | Solidity 0.8.26, Foundry, OpenZeppelin 5.x |
| ZK 证明 | Circom 2.1, PLONK, snarkjs |
| 前端 | Next.js 14, React 18, wagmi, viem, RainbowKit |
| 做市机器人 | TypeScript, viem |
| 部署网络 | Base Sepolia (L2) |
| 升级模式 | UUPS Proxy (Registry, SessionManager) |
| Hook 部署 | CREATE2 地址挖掘（满足 v4 位掩码 `0x0A80`） |

### 3.2 合约依赖关系

```
Registry (UUPS)
├── 管理 Issuer 白名单
├── 管理 Router 白名单
├── 管理 Session TTL
└── 紧急暂停控制

SessionManager (UUPS)
├── 依赖 Registry
├── 依赖 Verifier (验证 ZK proof)
├── VERIFIER_ROLE → startSession
├── ADMIN_ROLE → endSession / endSessionBatch
└── 24h TTL 自动过期

ComplianceHook (Uniswap v4 Hook)
├── 依赖 SessionManager (isSessionActive)
├── 依赖 Registry (isRouterApproved, isPaused)
├── beforeSwap / beforeAddLiquidity / beforeRemoveLiquidity
├── EIP-712 PermitData 签名验证
└── 地址位掩码 0x0A80（CREATE2 部署）

VerifiedPoolsPositionManager
├── 依赖 SessionManager
├── 依赖 Registry
├── 铸造不可转让 LP NFT
└── safeTransferFrom / transferFrom → revert

SimpleSwapRouter
├── 包装 Uniswap v4 unlock 模式
└── 处理 ETH/ERC20 结算
```

---

## 4. 智能合约体系

### 4.1 Registry（注册表）

**地址**: `0x4C4e91B9b0561f031A9eA6d8F4dcC0DE46A129BD`

核心功能：
- `registerIssuer(address)` — 注册合规发行方
- `approveRouter(address, bool)` — 白名单交易路由
- `setDefaultSessionTTL(uint256)` — 设置默认 Session 有效期
- `pause() / unpause()` — 紧急暂停

### 4.2 SessionManager（会话管理器）

**地址**: `0x53fA67Dbe5803432Ba8697Ac94C80B601Eb850e2`

核心功能：

| 函数 | 权限 | 说明 |
|------|------|------|
| `startSession(user, expiry)` | VERIFIER_ROLE | 激活链上 Session |
| `endSession(user)` | ADMIN_ROLE | 撤销单个 Session |
| `endSessionBatch(users[])` | ADMIN_ROLE | 批量撤销 |
| `isSessionActive(user)` | public (view) | 查询是否活跃 |
| `getRemainingTime(user)` | public (view) | 查询剩余时间 |
| `batchIsSessionActive(users[])` | public (view) | 批量查询 |

事件（可审计）：
```solidity
event SessionStarted(address indexed user, uint256 expiry);
event SessionEnded(address indexed user);
```

### 4.3 ComplianceHook（合规钩子）

**地址**: `0xba90d5Fe45b84b2b99e9C5A1A36C72695c514A80`

Uniswap v4 Hook，在每笔交易前执行合规检查：

| Hook | 检查项 |
|------|--------|
| `beforeSwap` | Session 有效 + EIP-712 签名 + 非暂停 |
| `beforeAddLiquidity` | Session 有效 + EIP-712 签名 + 非暂停 |
| `beforeRemoveLiquidity` | Session 有效 + EIP-712 签名（暂停时仍允许撤出） |

**用户身份解析**（`_resolveUser`）：

```
hookData 格式：
1. 完整 PermitData（EIP-712 签名） → 验签后提取 user
2. 空 hookData（EOA 直接调用） → 使用 msg.sender
3. 仅地址（白名单路由转发） → 检查 isRouterApproved
```

**地址位掩码**：

```
低 14 位: 0x0A80
  bit 7  (0x0080) = BEFORE_SWAP_FLAG         ✓
  bit 9  (0x0200) = BEFORE_REMOVE_LIQ_FLAG   ✓
  bit 11 (0x0800) = BEFORE_ADD_LIQ_FLAG      ✓
```

通过 CREATE2 盐值挖掘（salt `0x0cfc`）实现地址匹配。

### 4.4 VerifiedPoolsPositionManager（合规 LP 管理器）

**地址**: `0x5b460c8Bd32951183a721bdaa3043495D8861f31`

- 仅已验证用户可 mint/增加/减少流动性
- **LP NFT 不可转让** — `safeTransferFrom` 和 `transferFrom` 均 revert
- 防止合规份额流入未验证地址

### 4.5 PlonkVerifierAdapter（验证器适配器）

**地址**: `0x0cDcD82E5efba9De4aCc255402968397F323AFBB`

- 将通用 `bytes proof` + `uint256[] publicInputs` 转换为 PLONK 格式
- `verifyComplianceProof(proof, publicInputs)` — 只读验证
- `verifyAndExtractUser(proof, publicInputs)` — 验证并提取用户地址

---

## 5. 零知识证明系统

### 5.1 电路设计（`compliance.circom`）

```
ComplianceVerification(merkleDepth=10)

公开输入 (public):
  - userAddress        用户以太坊地址
  - merkleRoot         合规用户 Merkle 树根
  - issuerPubKeyHash   发行方公钥哈希

私有输入 (private):
  - signature          发行方签名
  - kycStatus          KYC 状态 (1=通过)
  - countryCode        国家代码
  - timestamp          验证时间戳
  - merklePathElements Merkle 路径
  - merklePathIndices  路径方向

约束:
  1. kycStatus === 1                            // 必须通过 KYC
  2. SignatureVerifier(msg, signature) === true  // 签名有效
  3. MerkleTreeChecker(leaf, root, path) === true // Merkle 成员证明
```

### 5.2 Web Worker 架构

```
主线程 (React)                      Web Worker
     │                                  │
     │── GENERATE_PROOF ──────────────▶ │
     │   (input, wasm/zkey paths)       │
     │                                  ├── 加载 WASM
     │◀─ PROGRESS (30%) ──────────────  │
     │                                  ├── 加载 ZKey
     │◀─ PROGRESS (60%) ──────────────  │
     │                                  ├── snarkjs.plonk.fullProve
     │◀─ PROGRESS (90%) ──────────────  │
     │                                  │
     │◀─ PROOF_READY ─────────────────  │
     │   (proof, publicSignals, time)   │
```

- **WASM/ZKey 缓存**：通过 IndexedDB 缓存，首次加载 ~2s，后续 <500ms
- **证明生成**：~3-4 秒（浏览器端 PLONK）
- **不阻塞 UI**：完全在 Web Worker 中执行

---

## 6. 前端合规流程

### 6.1 验证流程（`useVerification` — v2 升级版）

```typescript
// 步骤 1: 查询合规凭证（Multi-Issuer，fail-closed）
const result = await checkAllProviders(address);
// 生产模式：无凭证 → 直接拒绝
// 演示模式：允许 mock

// 步骤 2: 生成 ZK Proof（Web Worker）
const proof = await generateComplianceProof(address, attestation, onProgress);

// 步骤 3: 链上验证（只读，不花 gas）
const isValid = await publicClient.readContract({
  functionName: 'verifyComplianceProof',
  args: [proofBytes, publicInputs],
});

// 步骤 4: 链上激活 Session（writeContract，产生事件）
const hash = await walletClient.writeContract({
  functionName: 'startSession',
  args: [address, sessionExpiry],
});
// → 产生 SessionStarted 事件，可审计
```

### 6.2 Session 状态管理（`useSession`）

双源合并判断：

```
链上 SessionManager.isSessionActive(user) = true?  ──┐
                                                      ├── OR → 有效
本地 localStorage Session 有效?  ──────────────────────┘
```

实时倒计时 + 自动刷新。

### 6.3 EAS 状态展示（`useEAS` — v2 升级版）

| 模式 | 无凭证行为 | 错误行为 |
|------|------------|----------|
| 生产模式 | `hasAttestation=false`, 显示错误 | `hasAttestation=false`, 显示错误 |
| 演示模式 | 使用 mock, `isMock=true` | 使用 mock, `isMock=true` |

---

## 7. Multi-Issuer 合规架构（v2 新增）

### 7.1 架构设计

```
┌─────────────────────────────────────────────┐
│          合规凭证层 (Credential Layer)        │
├──────────────┬─────────────┬────────────────┤
│ Coinbase EAS │  Ondo KYB   │ Future Provider │
│ (已实现)     │  (接入点)   │ (Polygon ID等)  │
└──────┬───────┴──────┬──────┴───────┬────────┘
       │              │              │
       └──────┬───────┘──────────────┘
              ▼
     checkAllProviders()  ← 统一查询接口
              │
              ▼
        ZK Proof 生成
              │
              ▼
        链上验证 + Session 激活
```

### 7.2 Provider 注册 API

```typescript
import { registerKYCProvider } from '@/lib/eas';

// Ondo KYB 接入示例
registerKYCProvider({
  name: 'Ondo KYB',
  attesterAddress: '0x<ONDO_ATTESTER>',
  verify: async (userAddress) => {
    // 查询 Ondo 链上白名单或 API
    const isApproved = await ondoRegistry.isWhitelisted(userAddress);
    if (!isApproved) return null;
    return {
      uid: `ondo-${userAddress}`,
      issuerType: 'custom-kyc',
      verified: true,
      // ...
    };
  },
});
```

### 7.3 EAS Attestation 完整校验（v2 新增）

| 校验项 | 说明 | 不通过处理 |
|--------|------|-----------|
| `revocationTime > 0` | 凭证已被发行方撤销 | **拒绝** + 显示撤销时间 |
| `expirationTime < now` | 凭证已过期 | **拒绝** + 显示过期时间 |
| `attester !== trusted` | 发行方非可信地址 | **拒绝** + 显示发行方 |
| `schema !== known` | 未知 Schema ID | **警告**（不拒绝，但记录日志） |

### 7.4 Fail-Closed 策略

```
                    ┌─────────────────┐
                    │ 查询合规凭证     │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ 找到有效凭证？   │
                    └────────┬────────┘
                       YES   │   NO
                   ┌─────────┴──────────┐
                   ▼                    ▼
           ┌──────────┐        ┌──────────────┐
           │ 继续验证  │        │ DEMO_MODE?   │
           └──────────┘        └──────┬───────┘
                                 YES  │  NO
                            ┌─────────┴──────────┐
                            ▼                    ▼
                    ┌──────────┐          ┌──────────┐
                    │ 用 Mock  │          │ 拒绝操作  │
                    │ (仅开发) │          │ (fail-   │
                    └──────────┘          │  closed) │
                                          └──────────┘
```

---

## 8. 合规运营工具（v2 新增）

### 8.1 CLI 命令一览

```bash
npx tsx scripts/system-test/compliance-ops.ts <command>
```

| 命令 | 说明 | 权限要求 |
|------|------|---------|
| `info` | 显示合约地址、版本、网络信息 | 无 |
| `status <address>` | 查询 Session 状态、到期时间、剩余时间 | 无 |
| `revoke <address>` | 紧急撤销 Session | ADMIN_ROLE |
| `batch-status <file>` | 批量查询（每行一个地址） | 无 |
| `batch-revoke <file>` | 批量撤销 | ADMIN_ROLE |
| `grant-verifier <address>` | 授予 VERIFIER_ROLE | ADMIN_ROLE |
| `revoke-verifier <address>` | 撤销 VERIFIER_ROLE | ADMIN_ROLE |
| `export-report` | 导出 JSON + CSV 合规审计报告 | 无 |

### 8.2 测试结果

```
╔══════════════════════════════════════════════════╗
║    ILAL 合规运营工具 (Compliance Operations)     ║
╚══════════════════════════════════════════════════╝

ILAL 合约信息
════════════════════════════════════════════════════
  网络:           Base Sepolia (84532)
  SessionManager: 0x53fA67Dbe5803432Ba8697Ac94C80B601Eb850e2
  Registry:       0x4C4e91B9b0561f031A9eA6d8F4dcC0DE46A129BD
  ComplianceHook: 0xba90d5Fe45b84b2b99e9C5A1A36C72695c514A80
  Verifier:       0x0cDcD82E5efba9De4aCc255402968397F323AFBB
  版本:           1.0.0
```

```
查询 Session 状态: 0xd2C47Df9b9237fC2A01927cf940b36D571031CfF
────────────────────────────────────────────────────
  地址:     0xd2C47Df9b9237fC2A01927cf940b36D571031CfF
  状态:     ✅ 活跃
  到期时间:  2026-02-12T08:10:51.000Z
  剩余时间:  22h 22m 7s
```

### 8.3 导出报告示例

导出格式：JSON + CSV

```json
{
  "generatedAt": "2026-02-11T09:48:30.688Z",
  "network": "Base Sepolia (84532)",
  "sessionHistory": {
    "totalStarted": 3,
    "totalEnded": 0,
    "sessions": [
      { "user": "0xd2C47...", "expiry": "1770883851", "txHash": "0x69d355..." },
      { "user": "0x8d5c87...", "expiry": "1770883905", "txHash": "0x51080d..." },
      { "user": "0x0F7AD0...", "expiry": "1770885066", "txHash": "0x1d83aa..." }
    ],
    "revocations": []
  }
}
```

---

## 9. 做市机器人与监控

### 9.1 机器人配置

- **池**: USDC/WETH, fee=3000, tickSpacing=60
- **策略**: 价格区间流动性 + 套利重平衡
- **合规**: 持有活跃 Session + EIP-712 签名
- **告警**: Telegram 实时通知

### 9.2 Subgraph 索引

- 索引 `SessionStarted`, `SessionEnded`, `SwapAttempt`, `LiquidityAttempt` 事件
- 前端 `useHistory` hook 展示历史交易
- 目标同步延迟 < 30 秒

---

## 10. 部署信息

### 10.1 合约地址（Base Sepolia）

| 合约 | 地址 | 类型 |
|------|------|------|
| Registry | `0x4C4e91B9b0561f031A9eA6d8F4dcC0DE46A129BD` | UUPS Proxy |
| Registry Impl | `0xdbd5e1F35b825838b4e7dBEEdFa228BA4dC0628E` | Implementation |
| SessionManager | `0x53fA67Dbe5803432Ba8697Ac94C80B601Eb850e2` | UUPS Proxy |
| SessionManager Impl | `0x807814E5f95C6Dfbaa00573D0E407EB166566511` | Implementation |
| ComplianceHook | `0xba90d5Fe45b84b2b99e9C5A1A36C72695c514A80` | CREATE2 (salt: 0x0cfc) |
| PositionManager | `0x5b460c8Bd32951183a721bdaa3043495D8861f31` | Standard |
| SimpleSwapRouter | `0x2AAF6C551168DCF22804c04DdA2c08c82031F289` | Standard |
| PlonkVerifier | `0x2645C48A7DB734C9179A195C51Ea5F022B86261f` | Standard |
| PlonkVerifierAdapter | `0x0cDcD82E5efba9De4aCc255402968397F323AFBB` | Standard |
| PoolManager (Uniswap v4) | `0x05E73354cFDd6745C338b50BcFDfA3Aa6fA03408` | Uniswap |

### 10.2 代币地址

| 代币 | 地址 |
|------|------|
| WETH | `0x4200000000000000000000000000000000000006` |
| USDC | `0x036CbD53842c5426634e7929541eC2318f3dCF7e` |

### 10.3 Pool 配置

| 参数 | 值 |
|------|-----|
| currency0 | USDC (`0x036C...`) |
| currency1 | WETH (`0x4200...`) |
| fee | 3000 (0.3%) |
| tickSpacing | 60 |
| hooks | ComplianceHook (`0xba90...`) |

---

## 11. 测试结果

### 11.1 前端编译

```
✓ Compiled successfully
✓ Linting and checking validity of types
✓ Generating static pages (7/7)

Route (app)                    Size      First Load JS
┌ ○ /                          7.64 kB   320 kB
├ ○ /history                   3.99 kB   300 kB
├ ○ /liquidity                 5.81 kB   316 kB
└ ○ /trade                     5.27 kB   315 kB

Build time: 14.2s
```

**结果**: 所有页面编译通过，无类型错误，无 lint 错误。

### 11.2 合规运营工具

| 命令 | 结果 | 耗时 |
|------|------|------|
| `info` | 成功 — 读取到版本 1.0.0 | 1.8s |
| `status 0xd2C4...` | 成功 — 活跃，剩余 22h | 3.1s |
| `status 0x53fA...` | 成功 — 未激活 | 1.4s |
| `export-report` | 成功 — 3 个 SessionStarted，0 个 EndSession | 6.6s |

### 11.3 链上 Session 数据（实时验证）

| 用户地址 | 到期时间 | 区块号 | 交易哈希 |
|----------|----------|--------|----------|
| `0xd2C47Df9...` | 2026-02-12 08:10 UTC | 37,514,584 | `0x69d355...` |
| `0x8d5c8709...` | 2026-02-12 08:11 UTC | 37,514,611 | `0x51080d...` |
| `0x0F7AD0aB...` | 2026-02-12 08:31 UTC | 37,515,192 | `0x1d83aa...` |

### 11.4 Hook 地址位掩码验证

```
地址: 0xba90d5Fe45b84b2b99e9C5A1A36C72695c514A80
低 14 位: 0x0A80

位分析:
  bit 7  (0x0080) BEFORE_SWAP             ✓
  bit 9  (0x0200) BEFORE_REMOVE_LIQUIDITY ✓
  bit 11 (0x0800) BEFORE_ADD_LIQUIDITY    ✓

ALL_HOOK_MASK & address = 0x0A80 = 所需掩码  ✓
```

---

## 12. 安全分析

### 12.1 访问控制

| 角色 | 权限 | 持有者 |
|------|------|--------|
| DEFAULT_ADMIN_ROLE | 升级合约、撤销 Session、管理角色 | 治理钱包 |
| VERIFIER_ROLE | 激活 Session | 验证服务后端 |
| Router 白名单 | 通过 ComplianceHook 转发交易 | SimpleSwapRouter |

### 12.2 安全机制

| 机制 | 说明 |
|------|------|
| **UUPS 升级** | Registry 和 SessionManager 可安全升级 |
| **EIP-712 防伪造** | 前端无法伪造 hookData，需要有效签名 |
| **Replay 保护** | EIP-712 签名包含 deadline 和 nonce |
| **紧急暂停** | `Registry.pause()` 立即暂停所有交易 |
| **优雅退出** | 暂停时仍允许 `removeLiquidity`（用户可撤资） |
| **NFT 不可转让** | LP 份额无法转移到未验证地址 |
| **Session 自动过期** | 24h TTL，无需手动清理 |
| **Fail-Closed** | 凭证不可用 → 拒绝操作（不默认放行） |
| **完整 Attestation 校验** | 检查 revocation/expiration/attester/schema |

### 12.3 已知限制（透明披露）

| 项目 | 当前状态 | 计划 |
|------|---------|------|
| ZK 签名验证 | 简化版（Poseidon） | 升级为 EdDSA/ECDSA |
| 合约审计 | 未进行 | 主网前完成 |
| 前端 VERIFIER_ROLE | 需后端服务 | 部署 verifier relay |
| 多链支持 | 仅 Base Sepolia | 扩展到 Base Mainnet + Ethereum |

---

## 13. 问题解决记录

### 13.1 Uniswap v4 Hook 地址位掩码（关键修复）

**问题**: 原始 ComplianceHook 地址 `0x3407...` 不满足 v4 位掩码要求 `0x0A80`

**解决方案**:
1. 分析 `Hooks.sol` 确定所需位掩码
2. 开发 TypeScript 盐值挖掘工具（3,325 次尝试，0.02 秒）
3. 通过标准 CREATE2 Deployer 重新部署
4. 初始化新 Pool（修正 currency 排序 USDC < WETH）
5. 更新所有配置（前端、机器人、测试脚本）

**结果**: 新地址 `0xba90d5Fe45b84b2b99e9C5A1A36C72695c514A80` 完全满足 v4 要求。

### 13.2 SimpleSwapRouter 未授权

**问题**: Router 未在 Registry 注册为白名单

**解决方案**: 使用治理钱包调用 `Registry.approveRouter(SimpleSwapRouter, true)`

### 13.3 v2 架构升级（本次完成）

**问题**: 前端验证流程存在安全隐患

| 隐患 | 修复 |
|------|------|
| Session 仅存 localStorage | 改为链上 `startSession` |
| 凭证不可用时自动 mock | 改为 fail-closed |
| 仅支持 Coinbase EAS | 改为 Multi-Issuer |
| Attestation 仅检查 uid | 完整校验 4 项 |
| 无运营工具 | 开发 CLI 工具 |

---

## 14. Ondo 对接就绪度评估

### 14.1 评分卡

| 维度 | 满分 | 得分 | 说明 |
|------|------|------|------|
| 合规准入控制 | 20 | 18 | 链上 Session + Hook 拦截，缺 EdDSA 签名 |
| 隐私保护 | 20 | 18 | ZK Proof 浏览器生成，缺生产级签名验证 |
| 凭证灵活性 | 15 | 14 | Multi-Issuer 架构，`registerKYCProvider` 一行代码接入 |
| 可审计性 | 15 | 15 | 链上事件 + CLI 导出 JSON/CSV |
| 运营工具 | 10 | 9 | 查询/撤销/批量/导出报告齐全 |
| 安全机制 | 10 | 8 | fail-closed + EIP-712 + 紧急暂停，缺审计 |
| 文档就绪 | 10 | 9 | 完整集成指南 + 路线图 |
| **总分** | **100** | **91** | **可演示，接近生产就绪** |

### 14.2 Ondo 对接步骤

```
Phase 1: PoC 演示（1-2 周）
├── 在 Base Sepolia 演示完整合规交易流程
├── 用 Ondo 提供的测试白名单跑通 Session + Swap
└── 提供审计日志导出

Phase 2: KYB 集成（2-4 周）
├── 接入 Ondo KYB Provider API
├── 自定义 ZK Circuit 输入
└── 部署 Ondo 专属 SessionManager

Phase 3: 主网部署（4-8 周）
├── 合约审计
├── Base 主网部署
├── OUSG/USDY 池创建
└── 做市机器人对接
```

### 14.3 给 Ondo 的 Pitch 要点

1. **"我们不绑定 Coinbase"** — `registerKYCProvider()` 一行代码接入 Ondo 的 KYB 系统
2. **"链上可审计"** — 每笔 Session 操作产生链上事件，可导出 JSON/CSV
3. **"fail-closed"** — 凭证不可用时拒绝操作，不默认放行
4. **"紧急响应"** — `batch-revoke` 批量撤销 + `pause()` 全局暂停
5. **"OUSG/USDY 二级市场"** — Uniswap v4 深度流动性，仅限合规用户参与

---

## 15. 路线图

### 已完成 ✓

- [x] 核心合约体系（Registry / SessionManager / ComplianceHook / PositionManager）
- [x] ZK 证明系统（Circom + PLONK + Web Worker）
- [x] 前端完整 UI（验证 / 交易 / 流动性 / 历史）
- [x] Hook 地址位掩码修复（CREATE2 重新部署）
- [x] v2 架构升级：链上 Session 激活
- [x] v2 架构升级：fail-closed 合规策略
- [x] v2 架构升级：Multi-Issuer 凭证架构
- [x] v2 架构升级：完整 Attestation 校验
- [x] v2 架构升级：合规运营 CLI 工具
- [x] v2 架构升级：Ondo 对接文档

### 下一步

- [ ] 部署 Verifier Relay 后端（为前端代理 `startSession` 调用）
- [ ] 升级 ZK 电路签名验证（EdDSA/ECDSA）
- [ ] 合约安全审计
- [ ] Base 主网部署
- [ ] 接入 Ondo KYB Provider
- [ ] OUSG/USDY 池创建
- [ ] 跨链扩展（Ethereum L1）

---

## 附录

### A. 文件结构

```
ilal/
├── contracts/                    # Solidity 合约 (Foundry)
│   ├── src/
│   │   ├── core/                 # Registry, SessionManager, ComplianceHook, PositionManager
│   │   ├── helpers/              # SimpleSwapRouter
│   │   ├── verifiers/            # PlonkVerifier, PlonkVerifierAdapter
│   │   └── interfaces/           # IRegistry, ISessionManager, IVerifier
│   ├── script/                   # 部署脚本
│   └── test/                     # Foundry 测试
├── circuits/                     # ZK 电路 (Circom)
│   └── compliance.circom
├── frontend/                     # Next.js 14 前端
│   ├── app/                      # 页面路由
│   ├── hooks/                    # useVerification, useSession, useEAS
│   ├── lib/                      # contracts, eas, zkProof, demo-mode
│   └── public/workers/           # zkProof.worker.js
├── bot/                          # 做市机器人
│   ├── config.yaml
│   └── src/
├── scripts/
│   └── system-test/              # 系统测试 + 合规运营工具
│       ├── index.ts              # 系统集成测试
│       ├── grand-final.ts        # 全链路模拟
│       └── compliance-ops.ts     # 合规运营 CLI
├── deployments/                  # 部署记录
├── docs/                         # 文档
│   ├── guides/                   # ONDO_INTEGRATION_GUIDE.md
│   └── reports/                  # 合规报告, 项目报告
└── subgraph/                     # The Graph 索引
```

### B. 环境变量

| 变量 | 说明 | 影响 |
|------|------|------|
| `NEXT_PUBLIC_ENABLE_MOCK` | `true` = 演示模式 | 允许 mock attestation |
| `NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID` | WalletConnect ID | 钱包连接 |
| `PRIVATE_KEY` | 治理钱包私钥 | 合规运营操作 |
| `RPC_URL` | RPC 端点 | 链上交互 |

### C. 关键交互命令

```bash
# 查询 Session 状态
npx tsx scripts/system-test/compliance-ops.ts status 0x...

# 导出合规报告
npx tsx scripts/system-test/compliance-ops.ts export-report

# 前端开发
cd frontend && npm run dev

# 合约编译
cd contracts && forge build

# 运行系统测试
cd scripts/system-test && npx tsx index.ts
```

---

*ILAL v2 — 让合规机构也能享受 DeFi 流动性*

*报告生成时间: 2026-02-11 | 版本: v2.0*
