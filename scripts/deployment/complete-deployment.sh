#!/bin/bash
# ILAL å®Œæ•´éƒ¨ç½²ä¸»æ§è„šæœ¬

set -e

# é¢œè‰²è¾“å‡º
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
success() { echo -e "${GREEN}âœ… $1${NC}"; }
warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
header() { echo -e "${CYAN}$1${NC}"; }

clear
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸš€ ILAL å®Œæ•´éƒ¨ç½²åŠ©æ‰‹                 â•‘
â•‘   Institutional Liquidity Access Layer â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

echo ""
info "å½“å‰éƒ¨ç½²çŠ¶æ€ï¼š"
echo ""
echo "  âœ… å‰ç«¯: å·²æ„å»ºå¹¶è¿è¡Œ"
echo "     åœ°å€: http://localhost:3000"
echo ""
echo "  ğŸŸ¡ å­å›¾: æ„å»ºå®Œæˆï¼Œç­‰å¾…éƒ¨ç½²"
echo "  ğŸŸ¡ æœºå™¨äºº: æ„å»ºå®Œæˆï¼Œç­‰å¾…é…ç½®"
echo ""
echo "=========================================="
echo ""

header "è¯·é€‰æ‹©è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼š"
echo ""
echo "  1. éƒ¨ç½²å­å›¾åˆ° The Graph Studio"
echo "  2. é…ç½®å¹¶å¯åŠ¨åšå¸‚æœºå™¨äºº"
echo "  3. ä¸¤ä¸ªéƒ½å®Œæˆï¼ˆæ¨èï¼‰"
echo "  4. æŸ¥çœ‹å½“å‰çŠ¶æ€"
echo "  5. é€€å‡º"
echo ""
read -p "è¯·é€‰æ‹© (1-5): " CHOICE

case $CHOICE in
    1)
        clear
        header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        header "  ä»»åŠ¡ 1: éƒ¨ç½²å­å›¾"
        header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        ./deploy-subgraph-interactive.sh
        ;;
    2)
        clear
        header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        header "  ä»»åŠ¡ 2: é…ç½®å¹¶å¯åŠ¨æœºå™¨äºº"
        header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        ./setup-bot-interactive.sh
        ;;
    3)
        clear
        header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        header "  å®Œæ•´éƒ¨ç½²æµç¨‹"
        header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        info "æˆ‘ä»¬å°†ä¾æ¬¡å®Œæˆï¼š"
        echo "  1ï¸âƒ£  éƒ¨ç½²å­å›¾"
        echo "  2ï¸âƒ£  é…ç½®å¹¶å¯åŠ¨æœºå™¨äºº"
        echo ""
        read -p "æŒ‰ Enter å¼€å§‹..."
        
        # ä»»åŠ¡ 1: éƒ¨ç½²å­å›¾
        clear
        header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        header "  ä»»åŠ¡ 1/2: éƒ¨ç½²å­å›¾"
        header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        ./deploy-subgraph-interactive.sh
        
        echo ""
        success "å­å›¾éƒ¨ç½²å®Œæˆï¼"
        echo ""
        read -p "æŒ‰ Enter ç»§ç»­é…ç½®æœºå™¨äºº..."
        
        # ä»»åŠ¡ 2: é…ç½®æœºå™¨äºº
        clear
        header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        header "  ä»»åŠ¡ 2/2: é…ç½®å¹¶å¯åŠ¨æœºå™¨äºº"
        header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        ./setup-bot-interactive.sh
        
        echo ""
        success "ğŸ‰ æ‰€æœ‰éƒ¨ç½²ä»»åŠ¡å®Œæˆï¼"
        ;;
    4)
        clear
        header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        header "  å½“å‰éƒ¨ç½²çŠ¶æ€"
        header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        # æ£€æŸ¥å‰ç«¯
        if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1; then
            success "å‰ç«¯: è¿è¡Œä¸­ (http://localhost:3000)"
        else
            warning "å‰ç«¯: æœªè¿è¡Œ"
        fi
        
        # æ£€æŸ¥å­å›¾
        if [ -d "subgraph/build" ]; then
            success "å­å›¾: å·²æ„å»º"
            if [ -f "subgraph/.graph-auth" ]; then
                success "å­å›¾: å·²è®¤è¯"
            else
                warning "å­å›¾: æœªéƒ¨ç½²"
            fi
        else
            warning "å­å›¾: æœªæ„å»º"
        fi
        
        # æ£€æŸ¥æœºå™¨äºº
        if [ -f "bot/dist/index.js" ]; then
            success "æœºå™¨äºº: å·²æ„å»º"
            if grep -q "0x0000000000000000000000000000000000000000000000000000000000000000" bot/.env 2>/dev/null; then
                warning "æœºå™¨äºº: ç§é’¥æœªé…ç½®"
            else
                success "æœºå™¨äºº: å·²é…ç½®"
            fi
        else
            warning "æœºå™¨äºº: æœªæ„å»º"
        fi
        
        echo ""
        info "è¯¦ç»†ä¿¡æ¯ï¼š"
        echo "  - æŸ¥çœ‹å‰ç«¯: open http://localhost:3000"
        echo "  - éƒ¨ç½²å­å›¾: ./complete-deployment.sh"
        echo "  - é…ç½®æœºå™¨äºº: ./complete-deployment.sh"
        ;;
    5)
        info "é€€å‡º"
        exit 0
        ;;
    *)
        warning "æ— æ•ˆçš„é€‰æ‹©"
        exit 1
        ;;
esac

echo ""
echo "=========================================="
success "âœ¨ æ“ä½œå®Œæˆï¼"
echo "=========================================="
echo ""
info "å¿«é€Ÿå‘½ä»¤ï¼š"
echo "  å‰ç«¯: open http://localhost:3000"
echo "  å­å›¾: cat GRAPH_STUDIO_SETUP.md"
echo "  æœºå™¨äºº: cd bot && npm run test:config"
echo ""
