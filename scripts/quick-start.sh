#!/bin/bash

# ILAL å¿«é€Ÿå¯åŠ¨ï¼ˆæ— éœ€ sudoï¼Œæ— éœ€ PostgreSQLï¼‰

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     ILAL å¿«é€Ÿå¯åŠ¨ï¼ˆæ— æƒé™è¦æ±‚ï¼‰                  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

cd "$(dirname "$0")/apps/api"

echo "âœ… ä½¿ç”¨ Node.js $(node --version)"
echo "âœ… ä½¿ç”¨ npm $(npm --version)"
echo ""

# æ­¥éª¤ 1: å®‰è£…ä¾èµ–
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "æ­¥éª¤ 1: å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨ npmï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
npm install

# æ­¥éª¤ 2: é…ç½®çŽ¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨ SQLiteï¼‰
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "æ­¥éª¤ 2: é…ç½®çŽ¯å¢ƒï¼ˆä½¿ç”¨ SQLiteï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -f ".env" ]; then
    echo "âš ï¸  .env å·²å­˜åœ¨ï¼Œå¤‡ä»½ä¸º .env.backup"
    cp .env .env.backup
fi

# ç”Ÿæˆæµ‹è¯•å¯†é’¥
JWT_SECRET=$(openssl rand -hex 32)
API_KEY_SECRET=$(openssl rand -hex 32)
TEST_KEY=$(openssl rand -hex 32)

cat > .env << EOF
# SQLite æ•°æ®åº“ï¼ˆæ— éœ€ PostgreSQLï¼‰
DATABASE_URL="file:./dev.db"

# JWT
JWT_SECRET="$JWT_SECRET"
JWT_EXPIRES_IN="7d"
JWT_REFRESH_EXPIRES_IN="30d"

# API Key
API_KEY_SECRET="$API_KEY_SECRET"

# æœåŠ¡å™¨
PORT=3001
NODE_ENV="development"

# åŒºå—é“¾ï¼ˆæµ‹è¯•é…ç½®ï¼‰
RPC_URL="https://base-sepolia-rpc.publicnode.com"
CHAIN_ID=84532
VERIFIER_PRIVATE_KEY="0x$TEST_KEY"
SESSION_MANAGER_ADDRESS="0x53fA67Dbe5803432Ba8697Ac94C80B601Eb850e2"
VERIFIER_ADDRESS="0x0cDcD82E5efba9De4aCc255402968397F323AFBB"

# é™æµ
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX_REQUESTS_FREE=10
RATE_LIMIT_MAX_REQUESTS_PRO=100
RATE_LIMIT_MAX_REQUESTS_ENTERPRISE=1000
EOF

echo "âœ… çŽ¯å¢ƒé…ç½®å®Œæˆï¼ˆä½¿ç”¨ SQLiteï¼‰"

# æ­¥éª¤ 3: ä¿®æ”¹ Prisma Schema ä¸º SQLite
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "æ­¥éª¤ 3: é…ç½®æ•°æ®åº“ï¼ˆSQLiteï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# å¤‡ä»½åŽŸå§‹ schema
cp prisma/schema.prisma prisma/schema.prisma.backup

# ä¿®æ”¹ä¸º SQLite
sed -i '' 's/provider = "postgresql"/provider = "sqlite"/' prisma/schema.prisma

echo "âœ… æ•°æ®åº“é…ç½®ä¸º SQLite"

# æ­¥éª¤ 4: ç”Ÿæˆ Prisma Client
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "æ­¥éª¤ 4: ç”Ÿæˆæ•°æ®åº“å®¢æˆ·ç«¯"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

npx prisma generate

# æ­¥éª¤ 5: åˆ›å»ºæ•°æ®åº“
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "æ­¥éª¤ 5: åˆ›å»ºæ•°æ®åº“è¡¨"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

npx prisma db push

echo "âœ… æ•°æ®åº“å·²åˆ›å»º"

# å®Œæˆ
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     é…ç½®å®Œæˆï¼                                    â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ðŸŽ‰ API æœåŠ¡å·²å‡†å¤‡å°±ç»ªï¼"
echo ""
echo "å¯åŠ¨æœåŠ¡ï¼š"
echo "  npm run dev"
echo ""
echo "æˆ–è¿è¡Œæµ‹è¯•ï¼š"
echo "  npx tsx test-e2e.ts"
echo ""
echo "âš ï¸  æ³¨æ„ï¼š"
echo "  - ä½¿ç”¨ SQLite æœ¬åœ°æ•°æ®åº“ï¼ˆdev.dbï¼‰"
echo "  - ä½¿ç”¨æµ‹è¯•ç§é’¥ï¼ˆæ— ä½™é¢ï¼ŒåŒºå—é“¾åŠŸèƒ½å—é™ï¼‰"
echo "  - è®¤è¯ã€API Keyã€è®¡è´¹åŠŸèƒ½å®Œå…¨å¯ç”¨"
echo ""

# è¯¢é—®æ˜¯å¦å¯åŠ¨æœåŠ¡
read -p "æ˜¯å¦ç«‹å³å¯åŠ¨æœåŠ¡ï¼Ÿ(y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    echo "ðŸš€ å¯åŠ¨ API æœåŠ¡..."
    npm run dev
fi
