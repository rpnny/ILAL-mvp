// Prisma Schema for ILAL SaaS
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users table
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  name          String?
  walletAddress String?  @unique
  emailVerified Boolean  @default(false)
  plan          Plan     @default(FREE)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  apiKeys           ApiKey[]
  usageRecords      UsageRecord[]
  subscriptions     Subscription[]
  verificationCodes VerificationCode[]

  @@index([email])
  @@index([walletAddress])
}

// Email verification codes
model VerificationCode {
  id        String   @id @default(cuid())
  userId    String
  code      String   // 6-digit code
  type      String   @default("EMAIL_VERIFY") // EMAIL_VERIFY | PASSWORD_RESET
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
}

// API Keys table
model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  key         String   @unique  // bcrypt hash of actual key
  keyPrefix   String             // First 4 chars for identification (e.g. "ilal")
  name        String
  permissions Json     @default("[]") // ["verify", "session", "usage"]
  rateLimit   Int      @default(10)   // Requests per minute
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
  
  user         User @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageRecords UsageRecord[]

  @@index([userId])
  @@index([keyPrefix])
}

// Usage records table
model UsageRecord {
  id          String   @id @default(cuid())
  userId      String
  apiKeyId    String
  endpoint    String   // "/api/v1/verify"
  method      String   // "POST"
  statusCode  Int
  cost        Float    @default(1.0) // Billing weight
  responseTime Int?    // Response time (ms)
  timestamp   DateTime @default(now())
  
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
  @@index([apiKeyId, timestamp])
}

// Subscriptions table
model Subscription {
  id                 String             @id @default(cuid())
  userId             String
  plan               Plan
  status             SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  createdAt          DateTime           @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Plan tiers
enum Plan {
  FREE        // Free: 100 calls/month, 10 req/min
  PRO         // Pro: 10,000 calls/month, 100 req/min
  ENTERPRISE  // Enterprise: Unlimited, 1000 req/min
}

// Subscription status
enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  EXPIRED
}
