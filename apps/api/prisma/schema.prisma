// Prisma Schema for ILAL SaaS
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Users table
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  name          String?
  walletAddress String?  @unique
  emailVerified Int      @default(0)  // SQLite: 1=true, 0=false
  plan          String   @default("FREE")  // "FREE" | "PRO" | "ENTERPRISE"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  apiKeys           ApiKey[]
  usageRecords      UsageRecord[]
  subscriptions     Subscription[]
  verificationCodes VerificationCode[]
}

// Email verification codes
model VerificationCode {
  id        String   @id @default(cuid())
  userId    String
  code      String   // 6-digit code
  type      String   @default("EMAIL_VERIFY") // EMAIL_VERIFY | PASSWORD_RESET
  expiresAt String   // ISO string
  used      Int      @default(0)  // SQLite: 1=true, 0=false
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// API Keys table
model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  key         String   @unique  // bcrypt hash of actual key
  keyPrefix   String             // First 4 chars for identification (e.g. "ilal")
  name        String
  permissions String   @default("verify,session") // Comma-separated: "verify,session,usage"
  rateLimit   Int      @default(10)   // Requests per minute
  isActive    Int      @default(1)    // SQLite: 1=true, 0=false
  lastUsedAt  String?  // ISO string
  createdAt   DateTime @default(now())
  expiresAt   String?  // ISO string
  
  user         User @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageRecords UsageRecord[]
}

// Usage records table
model UsageRecord {
  id           String   @id @default(cuid())
  userId       String
  apiKeyId     String
  endpoint     String   // "/api/v1/verify"
  method       String   // "POST"
  statusCode   Int
  cost         Float    @default(1.0) // Billing weight
  responseTime Int?     // Response time (ms)
  timestamp    DateTime @default(now())
  
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
}

// Subscriptions table
model Subscription {
  id                   String   @id @default(cuid())
  userId               String
  plan                 String   // "FREE" | "PRO" | "ENTERPRISE"
  status               String   @default("ACTIVE") // "ACTIVE" | "CANCELLED" | "PAST_DUE" | "EXPIRED"
  currentPeriodStart   String   // ISO string
  currentPeriodEnd     String   // ISO string
  stripeCustomerId     String?  // Stripe customer ID for webhook lookup
  stripeSubscriptionId String?  // Stripe subscription ID
  createdAt            DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

