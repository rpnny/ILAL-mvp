# ILAL 子图 Schema 定义

"""
发行方实体 - 管理可信的身份验证提供者
"""
type Issuer @entity {
  id: Bytes!                    # issuerId
  attester: Bytes!              # Attester 地址
  verifier: Bytes!              # Verifier 合约地址
  active: Boolean!              # 是否启用
  registeredAt: BigInt!         # 注册时间戳
  updatedAt: BigInt!            # 最后更新时间
  revokedAt: BigInt             # 撤销时间（如果被撤销）
  
  # 关系
  sessions: [Session!]! @derivedFrom(field: "issuer")
}

"""
用户会话实体 - 记录验证状态
"""
type Session @entity {
  id: Bytes!                    # user address
  user: Bytes!                  # 用户地址
  expiry: BigInt!               # 过期时间戳
  startedAt: BigInt!            # 开始时间
  endedAt: BigInt               # 结束时间（如果被手动结束）
  isActive: Boolean!            # 当前是否有效
  
  # 关系
  issuer: Issuer                # 使用的 Issuer
  swaps: [Swap!]! @derivedFrom(field: "user")
  liquidityPositions: [LiquidityPosition!]! @derivedFrom(field: "owner")
}

"""
交换交易实体
"""
type Swap @entity {
  id: Bytes!                    # 交易哈希 + logIndex
  user: Bytes!                  # 用户地址
  pool: Bytes!                  # 池子地址
  tokenIn: Bytes!               # 输入代币
  tokenOut: Bytes!              # 输出代币
  amountIn: BigInt!             # 输入数量
  amountOut: BigInt!            # 输出数量
  timestamp: BigInt!            # 交易时间戳
  blockNumber: BigInt!          # 区块号
  txHash: Bytes!                # 交易哈希
  
  # 关系
  session: Session              # 关联的会话
}

"""
流动性头寸实体
"""
type LiquidityPosition @entity {
  id: Bytes!                    # NFT tokenId
  owner: Bytes!                 # 所有者地址
  pool: Bytes!                  # 池子地址
  token0: Bytes!                # Token 0
  token1: Bytes!                # Token 1
  liquidity: BigInt!            # 流动性数量
  tickLower: Int!               # 价格下界
  tickUpper: Int!               # 价格上界
  createdAt: BigInt!            # 创建时间
  updatedAt: BigInt!            # 最后更新时间
  removedAt: BigInt             # 移除时间
  isActive: Boolean!            # 是否仍有流动性
  
  # 关系
  session: Session              # 关联的会话
}

"""
紧急事件实体
"""
type EmergencyEvent @entity {
  id: Bytes!                    # 交易哈希 + logIndex
  paused: Boolean!              # 是否暂停
  timestamp: BigInt!            # 时间戳
  blockNumber: BigInt!          # 区块号
  txHash: Bytes!                # 交易哈希
  triggeredBy: Bytes!           # 触发者地址 (governance)
}

"""
路由器实体
"""
type Router @entity {
  id: Bytes!                    # 路由器地址
  approved: Boolean!            # 是否已批准
  approvedAt: BigInt!           # 批准时间
  revokedAt: BigInt             # 撤销时间
}

"""
全局统计实体
"""
type GlobalStats @entity {
  id: Bytes!                    # 固定为 "global"
  
  # 计数统计
  totalIssuers: Int!            # 总 Issuer 数
  activeIssuers: Int!           # 活跃 Issuer 数
  totalSessions: Int!           # 总会话数
  activeSessions: Int!          # 活跃会话数
  totalSwaps: Int!              # 总交易数
  totalLiquidityPositions: Int! # 总流动性头寸数
  
  # 金额统计
  totalVolumeUSD: BigDecimal!   # 总交易量 (USD)
  totalLiquidityUSD: BigDecimal! # 总锁仓量 (USD)
  
  # 时间统计
  lastUpdated: BigInt!          # 最后更新时间
}

"""
日统计实体
"""
type DailyStats @entity {
  id: Bytes!                    # 日期字符串 (YYYY-MM-DD)
  date: String!                 # 日期
  
  # 每日数据
  dailySwaps: Int!              # 当日交易数
  dailyVolumeUSD: BigDecimal!   # 当日交易量
  newSessions: Int!             # 新增会话
  expiredSessions: Int!         # 过期会话
  
  timestamp: BigInt!            # 日期时间戳
}
