# ILAL Subgraph Schema (简化版)
# 只记录验证事件，不记录详细的交易信息

"""
发行者实体
"""
type Issuer @entity {
  id: Bytes!                    # issuerHash (keccak256)
  admin: Bytes!                 # 管理员地址
  easAddress: Bytes!            # EAS 合约地址
  schemaId: Bytes!              # Schema ID
  isActive: Boolean!            # 是否活跃
  registeredAt: BigInt!         # 注册时间
  revokedAt: BigInt             # 吊销时间
  
  # 关系
  sessions: [Session!]! @derivedFrom(field: "issuer")
}

"""
用户会话实体
"""
type Session @entity {
  id: Bytes!                    # user address
  user: Bytes!                  # 用户地址
  expiry: BigInt!               # 过期时间戳
  startedAt: BigInt!            # 开始时间
  endedAt: BigInt               # 结束时间（如果被手动结束）
  isActive: Boolean!            # 当前是否有效
  
  # 关系
  issuer: Issuer                # 验证发行者
  swapAttempts: [SwapAttempt!]! @derivedFrom(field: "session")
  liquidityAttempts: [LiquidityAttempt!]! @derivedFrom(field: "session")
}

"""
Swap 尝试记录（简化版）
只记录 ComplianceHook 的验证事件
"""
type SwapAttempt @entity {
  id: ID!                       # txHash + logIndex
  user: Bytes!                  # 用户地址
  allowed: Boolean!             # 是否允许
  timestamp: BigInt!            # 时间戳
  blockNumber: BigInt!          # 区块号
  txHash: Bytes!                # 交易哈希
  
  # 关系
  session: Session              # 关联的 Session
}

"""
流动性操作尝试记录（简化版）
只记录 ComplianceHook 的验证事件
"""
type LiquidityAttempt @entity {
  id: ID!                       # txHash + logIndex
  user: Bytes!                  # 用户地址
  allowed: Boolean!             # 是否允许
  isAdd: Boolean!               # true=添加, false=移除
  timestamp: BigInt!            # 时间戳
  blockNumber: BigInt!          # 区块号
  txHash: Bytes!                # 交易哈希
  
  # 关系
  session: Session              # 关联的 Session
}

"""
路由器实体
"""
type Router @entity {
  id: Bytes!                    # router address
  address: Bytes!               # 路由器地址
  isApproved: Boolean!          # 是否被批准
  approvedAt: BigInt!           # 批准时间
  revokedAt: BigInt             # 吊销时间
}

"""
紧急事件实体
"""
type EmergencyEvent @entity {
  id: Bytes!                    # txHash
  isPaused: Boolean!            # 暂停状态
  triggeredBy: Bytes!           # 触发者
  timestamp: BigInt!            # 时间戳
  blockNumber: BigInt!          # 区块号
}

"""
全局统计实体
"""
type GlobalStats @entity {
  id: Bytes!                    # 固定为 0x00
  
  # 发行者统计
  totalIssuers: Int!            # 总发行者数
  activeIssuers: Int!           # 活跃发行者数
  
  # 会话统计
  totalSessions: Int!           # 总会话数
  activeSessions: Int!          # 活跃会话数
  
  # 操作统计
  totalSwapAttempts: Int!       # 总 Swap 尝试数
  totalLiquidityAttempts: Int!  # 总流动性操作尝试数
  allowedSwaps: Int!            # 允许的 Swap 数
  allowedLiquidityOps: Int!     # 允许的流动性操作数
  
  # 时间统计
  lastUpdated: BigInt!          # 最后更新时间
}

"""
日统计实体
"""
type DailyStats @entity {
  id: Bytes!                    # dayId (timestamp / 86400)
  date: String!                 # 日期字符串 (YYYY-MM-DD 或 day-N)
  
  # 操作统计
  dailySwapAttempts: Int!       # 当日 Swap 尝试数
  dailyLiquidityAttempts: Int!  # 当日流动性操作尝试数
  
  # 会话统计
  newSessions: Int!             # 当日新增会话
  expiredSessions: Int!         # 当日过期会话
  
  # 时间
  timestamp: BigInt!            # 日期对应的时间戳
}
